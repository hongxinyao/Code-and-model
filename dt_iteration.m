clear all;
Qreal=[1	1	0.53268
3	1	0.5445
5	1	0.56069
7	1	0.58146
9	1	0.60627
11	1	0.63362
13	1	0.66115
15	1	0.68583
17	1	0.70452
19	1	0.71461
21	1	0.71461
23	1	0.70452
25	1	0.68583
27	1	0.66115
29	1	0.63362
31	1	0.60627
33	1	0.58146
35	1	0.56069
37	1	0.5445
39	1	0.53268
1	3	0.5445
3	3	0.56322
5	3	0.5889
7	3	0.62183
9	3	0.66115
11	3	0.70452
13	3	0.74816
15	3	0.78729
17	3	0.81692
19	3	0.83291
21	3	0.83291
23	3	0.81692
25	3	0.78729
27	3	0.74816
29	3	0.70452
31	3	0.66115
33	3	0.62183
35	3	0.5889
37	3	0.56322
39	3	0.5445
1	5	0.56069
3	5	0.5889
5	5	0.62758
7	5	0.67718
9	5	0.7364
11	5	0.80172
13	5	0.86746
15	5	0.92639
17	5	0.97102
19	5	0.9951
21	5	0.9951
23	5	0.97102
25	5	0.92639
27	5	0.86746
29	5	0.80172
31	5	0.7364
33	5	0.67718
35	5	0.62758
37	5	0.5889
39	5	0.56069
1	7	0.58146
3	7	0.62183
5	7	0.67718
7	7	0.74816
9	7	0.83291
11	7	0.92639
13	7	1.02046
15	7	1.10479
17	7	1.16865
19	7	1.20312
21	7	1.20312
23	7	1.16865
25	7	1.10479
27	7	1.02046
29	7	0.92639
31	7	0.83291
33	7	0.74816
35	7	0.67718
37	7	0.62183
39	7	0.58146
1	9	0.60627
3	9	0.66115
5	9	0.7364
7	9	0.83291
9	9	0.94813
11	9	1.07523
13	9	1.20312
15	9	1.31778
17	9	1.40462
19	9	1.45148
21	9	1.45148
23	9	1.40462
25	9	1.31778
27	9	1.20312
29	9	1.07523
31	9	0.94813
33	9	0.83291
35	9	0.7364
37	9	0.66115
39	9	0.60627
1	11	0.63362
3	11	0.70452
5	11	0.80172
7	11	0.92639
9	11	1.07523
11	11	1.2394
13	11	1.40462
15	11	1.55273
17	11	1.66489
19	11	1.72543
21	11	1.72543
23	11	1.66489
25	11	1.55273
27	11	1.40462
29	11	1.2394
31	11	1.07523
33	11	0.92639
35	11	0.80172
37	11	0.70452
39	11	0.63362
1	13	0.66115
3	13	0.74816
5	13	0.86746
7	13	1.02046
9	13	1.20312
11	13	1.40462
13	13	1.60737
15	13	1.78915
17	13	1.92681
19	13	2.00111
21	13	2.00111
23	13	1.92681
25	13	1.78915
27	13	1.60737
29	13	1.40462
31	13	1.20312
33	13	1.02046
35	13	0.86746
37	13	0.74816
39	13	0.66115
1	15	0.68583
3	15	0.78729
5	15	0.92639
7	15	1.10479
9	15	1.31778
11	15	1.55273
13	15	1.78915
15	15	2.00111
17	15	2.16162
19	15	2.24825
21	15	2.24825
23	15	2.16162
25	15	2.00111
27	15	1.78915
29	15	1.55273
31	15	1.31778
33	15	1.10479
35	15	0.92639
37	15	0.78729
39	15	0.68583
1	17	0.70452
3	17	0.81692
5	17	0.97102
7	17	1.16865
9	17	1.40462
11	17	1.66489
13	17	1.92681
15	17	2.16162
17	17	2.33944
19	17	2.43541
21	17	2.43541
23	17	2.33944
25	17	2.16162
27	17	1.92681
29	17	1.66489
31	17	1.40462
33	17	1.16865
35	17	0.97102
37	17	0.81692
39	17	0.70452
1	19	0.71461
3	19	0.83291
5	19	0.9951
7	19	1.20312
9	19	1.45148
11	19	1.72543
13	19	2.00111
15	19	2.24825
17	19	2.43541
19	19	2.53643
21	19	2.53643
23	19	2.43541
25	19	2.24825
27	19	2.00111
29	19	1.72543
31	19	1.45148
33	19	1.20312
35	19	0.9951
37	19	0.83291
39	19	0.71461
1	21	0.71461
3	21	0.83291
5	21	0.9951
7	21	1.20312
9	21	1.45148
11	21	1.72543
13	21	2.00111
15	21	2.24825
17	21	2.43541
19	21	2.53643
21	21	2.53643
23	21	2.43541
25	21	2.24825
27	21	2.00111
29	21	1.72543
31	21	1.45148
33	21	1.20312
35	21	0.9951
37	21	0.83291
39	21	0.71461
1	23	0.70452
3	23	0.81692
5	23	0.97102
7	23	1.16865
9	23	1.40462
11	23	1.66489
13	23	1.92681
15	23	2.16162
17	23	2.33944
19	23	2.43541
21	23	2.43541
23	23	2.33944
25	23	2.16162
27	23	1.92681
29	23	1.66489
31	23	1.40462
33	23	1.16865
35	23	0.97102
37	23	0.81692
39	23	0.70452
1	25	0.68583
3	25	0.78729
5	25	0.92639
7	25	1.10479
9	25	1.31778
11	25	1.55273
13	25	1.78915
15	25	2.00111
17	25	2.16162
19	25	2.24825
21	25	2.24825
23	25	2.16162
25	25	2.00111
27	25	1.78915
29	25	1.55273
31	25	1.31778
33	25	1.10479
35	25	0.92639
37	25	0.78729
39	25	0.68583
1	27	0.66115
3	27	0.74816
5	27	0.86746
7	27	1.02046
9	27	1.20312
11	27	1.40462
13	27	1.60737
15	27	1.78915
17	27	1.92681
19	27	2.00111
21	27	2.00111
23	27	1.92681
25	27	1.78915
27	27	1.60737
29	27	1.40462
31	27	1.20312
33	27	1.02046
35	27	0.86746
37	27	0.74816
39	27	0.66115
1	29	0.63362
3	29	0.70452
5	29	0.80172
7	29	0.92639
9	29	1.07523
11	29	1.2394
13	29	1.40462
15	29	1.55273
17	29	1.66489
19	29	1.72543
21	29	1.72543
23	29	1.66489
25	29	1.55273
27	29	1.40462
29	29	1.2394
31	29	1.07523
33	29	0.92639
35	29	0.80172
37	29	0.70452
39	29	0.63362
1	31	0.60627
3	31	0.66115
5	31	0.7364
7	31	0.83291
9	31	0.94813
11	31	1.07523
13	31	1.20312
15	31	1.31778
17	31	1.40462
19	31	1.45148
21	31	1.45148
23	31	1.40462
25	31	1.31778
27	31	1.20312
29	31	1.07523
31	31	0.94813
33	31	0.83291
35	31	0.7364
37	31	0.66115
39	31	0.60627
1	33	0.58146
3	33	0.62183
5	33	0.67718
7	33	0.74816
9	33	0.83291
11	33	0.92639
13	33	1.02046
15	33	1.10479
17	33	1.16865
19	33	1.20312
21	33	1.20312
23	33	1.16865
25	33	1.10479
27	33	1.02046
29	33	0.92639
31	33	0.83291
33	33	0.74816
35	33	0.67718
37	33	0.62183
39	33	0.58146
1	35	0.56069
3	35	0.5889
5	35	0.62758
7	35	0.67718
9	35	0.7364
11	35	0.80172
13	35	0.86746
15	35	0.92639
17	35	0.97102
19	35	0.9951
21	35	0.9951
23	35	0.97102
25	35	0.92639
27	35	0.86746
29	35	0.80172
31	35	0.7364
33	35	0.67718
35	35	0.62758
37	35	0.5889
39	35	0.56069
1	37	0.5445
3	37	0.56322
5	37	0.5889
7	37	0.62183
9	37	0.66115
11	37	0.70452
13	37	0.74816
15	37	0.78729
17	37	0.81692
19	37	0.83291
21	37	0.83291
23	37	0.81692
25	37	0.78729
27	37	0.74816
29	37	0.70452
31	37	0.66115
33	37	0.62183
35	37	0.5889
37	37	0.56322
39	37	0.5445
1	39	0.53268
3	39	0.5445
5	39	0.56069
7	39	0.58146
9	39	0.60627
11	39	0.63362
13	39	0.66115
15	39	0.68583
17	39	0.70452
19	39	0.71461
21	39	0.71461
23	39	0.70452
25	39	0.68583
27	39	0.66115
29	39	0.63362
31	39	0.60627
33	39	0.58146
35	39	0.56069
37	39	0.5445
39	39	0.53268];    %Target heat flux
nx=20;               %grid number for heat flux
ny=20;
f=250;               %scanning frequency
R=0.002;             %beam radius
j=1,k=1;
while j<=ny
    i=1;
    while i<=nx
        Qreal1(i,j)=Qreal(k,3);
        i=i+1;
        k=k+1
    end
    j=j+1;
end
e_r=inputdlg('Please enter convergence precision[0-1]:');                
e_r=str2num(e_r{1});
n_max=inputdlg('Please enter the maximum iteration steps:');                
n_max=str2num(n_max{1});
dt=zeros(nx,ny)*0+1/f/nx/ny;
P=1000;
cycle_switch=1;
Nx=nx;        %grid number for scanning
Ny=ny;
R0=R;
Dx=R0;
dx=R0;
Dy=R0;
dy=R0;
Scanning_way=2;
Q=[];
n=1;
correction=1.1;
ft=1;
pro1=waitbar(0,'Target heat flux is being resolved£¡');     
while cycle_switch>0&&n<=n_max
      energy=zeros(nx,ny);
      dt=1/f/sum(sum(dt))*dt;
      ti=1;
      m=1;
      while ti<=Nx*Ny

    if Scanning_way==1
       J=floor(m/Nx)+1;                      
       I=rem(m,Nx);
       if I==0
          I=Nx;
          J=floor(m/Nx);
       end
    end
    
    if Scanning_way==2
       J=floor(m/Nx)+1;                      
       if rem(m,Nx)==0
           J=floor(m/Nx);
       end
       if rem(J,2)==1                      
          I=rem(m,Nx);
          if I==0
          I=Nx;
          end
       else
          I=Nx-rem(m,Nx)+1;
          if rem(m,Nx)==0
          I=1;
          end
       end
    end
    
    
    %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
    %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
    i=1;
    j=1;

      R=R0;

    while j<=ny
        i=1;
        while i<=nx
            energy(i,j)=energy(i,j)+3*P/3.14/R/R*exp(-3*(((I-1/2)*Dx-(i-1/2)*dx)^2+((J-1/2)*Dy-(j-1/2)*dy)^2)/R/R)*dx*dy*dt(I,J);   
            i=i+1;
        end
        j=j+1;
    end
    ti=ti+1;
    m=m+1;
      end
      Q=energy/(dx*dy*1/f);
      e=mean(Qreal1)/mean(Q);
      error=[];
      cycle_switch=0;
      i=1;
      while i<=Nx
            j=1;
            while j<=Ny
            error(i,j)=(e*Q(i,j)-Qreal1(i,j))/Qreal1(i,j);
            if error(i,j)>e_r
                dt(i,j)=dt(i,j)/correction;
                cycle_switch=1;
            end
            if error(i,j)<-e_r
                dt(i,j)=dt(i,j)*correction;
                cycle_switch=1;
            end 
            j=j+1;
            end
            i=i+1;
      end
      n=n+1;
      waitbar(e_r/max(max(abs(error))),pro1,['Completion' num2str(e_r/max(max(abs(error)))*100) '%']);  %½ø¶ÈÌõ
      if e_r/max(max(abs(error)))>0.2
         correction=1.05;
      end
      if e_r/max(max(abs(error)))>0.3
         correction=1.04;
      end
      if e_r/max(max(abs(error)))>0.5
         correction=1.03;
      end
      if e_r/max(max(abs(error)))>0.7
         correction=1.02;
      end
      
end
t_matrix=dt;
r=error;
j=1;
k=1;
while j<=Ny
    i=1;
    while i<=Nx
        out(k,1)=(i-1)*Dx+Dx/2;   %x-coordinate
        out(k,2)=(j-1)*Dy+Dy/2;   %y-coordinate
        out(k,3)=dt(i,j);         %Dwell duration
        out(k,4)=e*Q(i,j);        %Theoretical scanned heat flux
        i=i+1;
        k=k+1;
    end
    j=j+1;
end
        
      